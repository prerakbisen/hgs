<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard | HGS</title>

<style>
/* ---------------- GLOBAL ---------------- */
* { box-sizing: border-box; }

body {
    font-family: "Segoe UI", Arial, sans-serif;
    margin: 0;
    background: linear-gradient(135deg, #f4f7f6, #eef2f3);
    color: #333;
    display: flex;
    min-height: 100vh;
    animation: fadeIn 0.8s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.primary-green { background-color: #2ecc71; }
.text-primary-green { color: #2ecc71; }

/* ---------------- SIDEBAR ---------------- */
.sidebar {
    width: 250px;
    background: linear-gradient(180deg, #2c3e50, #1f2a36);
    color: white;
    padding-top: 20px;
    position: fixed;
    height: 100%;
    box-shadow: 4px 0 12px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
}

#myVideo {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -10;
    pointer-events: none;
}

.sidebar li { list-style: none; }
.sidebar ul {
    padding: 0;
    margin: 0;}

.sidebar h2 {
    text-align: center;
    margin-bottom: 35px;
    font-size: 26px;
    color: #2ecc71;
    letter-spacing: 1px;
}

.sidebar a {
    display: flex;
    align-items: center;
    padding: 15px 25px;
    color: white;
    text-decoration: none;
    transition: all 0.25s ease;
    font-size: 16px;
    border-left: 4px solid transparent;
}

.sidebar a svg {
    width: 20px;
    height: 20px;
    margin-right: 10px;
}

.sidebar a:hover,
.sidebar a.active {
    background-color: rgba(255,255,255,0.08);
    color: #2ecc71;
    border-left: 4px solid #2ecc71;
    transform: translateX(4px);
}

/* ---------------- MAIN CONTENT ---------------- */
.main-content {
    margin-left: 250px;
    flex-grow: 1;
    padding: 25px;
}

/* ---------------- HEADER ---------------- */
.header {
    background: white;
    padding: 18px 25px;
    border-radius: 10px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}

/* Toolbar */
.toolbar {
    display:flex;
    gap:12px;
    align-items:center;
    margin-bottom:16px;
}
.toolbar .search {
    flex:1;
    display:flex;
    gap:8px;
}
.toolbar input, .toolbar select { padding:8px 10px; border-radius:8px; border:1px solid #ddd; }
.toolbar button { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:#2ecc71; color:white; }
.toolbar button.secondary { background:transparent; border:1px solid #ccc; color:#333; }

/* Make table area a bit denser and interactive */
.grievance-section { padding: 18px; }
.grievance-table th, .grievance-table td { padding: 12px 12px; }
.grievance-table tbody tr:hover { background: linear-gradient(90deg, rgba(46,204,113,0.04), rgba(46,204,113,0.02)); }
.status-badge { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:600; font-size:12px; }
.muted { color:#777; font-size:13px; }

.actions { display:flex; gap:8px; align-items:center; }
.small-btn { padding:6px 10px; border-radius:8px; border:none; cursor:pointer; }
.small-btn.primary { background:#2ecc71; color:white; }
.small-btn.warn { background:#f39c12; color:white; }
.small-btn.gray { background:#eef0f2; color:#333; border:1px solid #ddd; }

.header h1 {
    margin: 0;
    font-size: 26px;
    font-weight: 600;
}

.user-info a {
    margin-left: 15px;
    padding: 8px 14px;
    border-radius: 6px;
    border: 1px solid #ddd;
    text-decoration: none;
    color: #555;
    transition: all 0.2s ease;
}

.user-info a:hover {
    background: #2ecc71;
    color: white;
    border-color: #2ecc71;
}

/* Logout button shared style */
.logout-btn { display:inline-block; padding:8px 12px; border-radius:6px; color:#555; text-decoration:none; border:1px solid #ddd; background:transparent; }
.logout-btn:hover{ background:#2ecc71; color:#fff; border-color:#2ecc71; }

/* Responsive adjustments */
/* ================= ADMIN DASHBOARD RESPONSIVE ================= */

/* Large tablets & small laptops */
@media (max-width: 1100px) {
    .sidebar { width: 210px; }
    .main-content { margin-left: 210px; padding: 18px; }
    .header h1 { font-size: 22px; }
    .widget-content p { font-size: 28px; }
}

/* Tablets */
@media (max-width: 900px) {
    .widgets-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .toolbar { flex-direction: column; align-items: stretch; gap: 10px; }
    .toolbar .search { width: 100%; }
    .grievance-table th, .grievance-table td { font-size: 13px; padding: 10px; }
}

/* Mobile */
@media (max-width: 700px) {

    body { flex-direction: column; }

    .sidebar {
        position: relative;
        width: 100%;
        height: 100px;
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 8px 10px;
    }

    .sidebar h2 {
        margin: 0;
        font-size: 16px;
        flex-shrink: 0;
    }

    .sidebar ul {
        display: flex;
        gap: 10px;
        margin-left: auto;
    }

    .sidebar li { list-style: none; }

    .sidebar a {
        padding: 8px 10px;
        font-size: 13px;
    }

    .sidebar a svg { width: 14px; height: 14px; margin-right: 6px; }

    .main-content { margin-left: 0; padding: 12px; }

    .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }

    .widgets-grid { grid-template-columns: 1fr; gap: 14px; }

    .grievance-section { padding: 14px; }

    .table-responsive { overflow-x: auto; }
}

/* ================= STAFF DASHBOARD TABLE RESPONSIVE ================= */

/* Tablets */
@media (max-width: 900px) {
    .grievance-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }
}

/* Mobile */
@media (max-width: 700px) {
    .grievance-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }
}

/* Small phones */
@media (max-width: 420px) {
    .grievance-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }
}


/* Very small phones */
@media (max-width: 420px) {

    .sidebar ul { flex-wrap: wrap; justify-content: center; }

    .sidebar a span { display: none; }

    .header h1 { font-size: 18px; }

    .widget-content p { font-size: 24px; }

    .small-btn, button.update-status { font-size: 12px; padding: 6px 8px; }
}


/* Make tables scroll horizontally on small screens */
.table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }

/* ---------------- WIDGETS ---------------- */
.widgets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 22px;
    margin-bottom: 30px;
}

.widget {
    background: white;
    padding: 22px;
    border-radius: 12px;
    box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.widget:hover {
    transform: translateY(-6px);
    box-shadow: 0 12px 26px rgba(0,0,0,0.12);
}

.widget-content h3 {
    margin: 0;
    font-size: 15px;
    color: #777;
}

.widget-content p {
    margin: 6px 0 0;
    font-size: 34px;
    font-weight: bold;
}

.widget-icon {
    width: 54px;
    height: 54px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.widget-icon svg {
    width: 24px;
    height: 24px;
    fill: white;
}

.widget.total .widget-icon { background: #2ecc71; }
.widget.pending .widget-icon { background: #f39c12; }
.widget.resolved .widget-icon { background: #3498db; }
.widget.users .widget-icon { background: #9b59b6; }

/* ---------------- TABLE ---------------- */
.grievance-section {
    background: white;
    padding: 22px;
    border-radius: 12px;
    box-shadow: 0 8px 18px rgba(0,0,0,0.08);
}

.grievance-section h2 {
    margin-top: 0;
    font-size: 22px;
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
}

.grievance-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.grievance-table th,
.grievance-table td {
    padding: 14px 15px;
    border-bottom: 1px solid #eee;
}

.grievance-table th {
    background: #f8f9fa;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.grievance-table tr {
    transition: background 0.2s ease, transform 0.2s ease;
}

.grievance-table tr:hover {
    background: #f4fdf8;
    transform: scale(1.005);
}

/* ---------------- STATUS TAGS ---------------- */
.status-tag {
    padding: 5px 10px;
    border-radius: 14px;
    font-size: 12px;
    font-weight: bold;
    color: white;
}

.status-pending { background: #f39c12; }
.status-resolved { background: #2ecc71; }
.status-in-review { background: #3498db; }
.status-investigating { background: #9b59b6; }
.status-closed { background: #ff0000; }

/* ---------------- FORM CONTROLS ---------------- */
select {
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    transition: border-color 0.2s ease;
}

select:focus {
    outline: none;
    border-color: #2ecc71;
}

button.update-status {
    padding: 7px 12px;
    margin-left: 6px;
    border-radius: 6px;
    border: none;
    background: #2ecc71;
    color: white;
    cursor: pointer;
    transition: all 0.25s ease;
}

button.update-status:hover {
    background: #27ae60;
    transform: translateY(-1px);
}
</style>
</head>

<body>

<div class="sidebar">
        <h2>HGS Admin</h2>
        <video autoplay muted loop playsinline preload="auto" id="myVideo">
        <source src="login bg video.mp4" type="video/mp4">
    </video>
        <ul>
            <li>
                <a href="#" class="active">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                    <span>Dashboard</span>
                </a>
            </li>
            <li>
                <a href="#complaints-section">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
                    <span>Grievances</span>
                </a>
            </li>
            <!-- <li>
                <a href="#">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0z"></path><path fill-rule="evenodd" d="M18 8a2 2 0 012 2v6a2 2 0 01-2 2H2a2 2 0 01-2-2v-6a2 2 0 012-2h12a2 2 0 002 2zm-5 4a1 1 0 100 2h.01a1 1 0 100-2H13zm-5-3a1 1 0 100 2h.01a1 1 0 100-2H8zm-2 2a1 1 0 100 2h.01a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
                    <span>Users</span>
                </a>
            </li> -->
            <!-- <li>
                <a href="#">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg>
                    <span>Reports</span>
                </a>
            </li> -->
            <li>
                <a href="#">
                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="20" height="20" viewBox="0,0,256,256">
<g fill="#fef9f9" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><g transform="scale(5.12,5.12)"><path d="M22.20508,2c-0.48953,0.00026 -0.90693,0.35484 -0.98633,0.83789l-0.97266,5.95508c-1.16958,0.34023 -2.28485,0.7993 -3.33594,1.37109l-4.91406,-3.50977c-0.39728,-0.28369 -0.94131,-0.23911 -1.28711,0.10547l-3.89062,3.88672c-0.3432,0.34344 -0.39015,0.88376 -0.11133,1.28125l3.45703,4.94531c-0.58061,1.05722 -1.04985,2.17878 -1.39844,3.35938l-5.92969,0.98633c-0.4815,0.0811 -0.83404,0.49805 -0.83398,0.98633v5.5c-0.00088,0.48518 0.3466,0.901 0.82422,0.98633l5.93359,1.05078c0.3467,1.17855 0.81296,2.30088 1.39453,3.35937l-3.5,4.89648c-0.28369,0.39728 -0.23911,0.94131 0.10547,1.28711l3.88867,3.89063c0.34265,0.34275 0.88175,0.39048 1.2793,0.11328l4.95508,-3.46875c1.05419,0.57517 2.17218,1.03762 3.3457,1.38086l0.99023,5.96289c0.08025,0.48228 0.49742,0.83584 0.98633,0.83594h5.5c0.4858,0.00071 0.90184,-0.34778 0.98633,-0.82617l1.06055,-5.98633c1.16868,-0.3485 2.28142,-0.8178 3.33008,-1.39648l4.98828,3.5c0.39749,0.27882 0.93781,0.23187 1.28125,-0.11133l3.88867,-3.89258c0.34612,-0.34687 0.38995,-0.89343 0.10352,-1.29102l-3.55664,-4.9375c0.56867,-1.04364 1.02681,-2.14972 1.36719,-3.31055l6.01758,-1.05469c0.47839,-0.08448 0.82689,-0.50053 0.82617,-0.98633v-5.5c-0.00026,-0.48953 -0.35484,-0.90693 -0.83789,-0.98633l-6.00781,-0.98242c-0.34266,-1.15945 -0.80206,-2.26356 -1.37109,-3.30664l3.50781,-4.99805c0.27882,-0.39749 0.23187,-0.93781 -0.11133,-1.28125l-3.89062,-3.88867c-0.34687,-0.34612 -0.89343,-0.38995 -1.29102,-0.10352l-4.92383,3.54102c-1.04908,-0.57636 -2.16255,-1.04318 -3.33398,-1.38867l-1.04687,-5.98437c-0.08364,-0.47917 -0.49991,-0.82867 -0.98633,-0.82812zM23.05664,4h3.80859l0.99609,5.68555c0.06772,0.38959 0.35862,0.70269 0.74219,0.79883c1.46251,0.36446 2.83609,0.94217 4.08984,1.70117c0.34265,0.20761 0.77613,0.1907 1.10156,-0.04297l4.67969,-3.36328l2.69336,2.69336l-3.33203,4.74805c-0.22737,0.3236 -0.24268,0.75079 -0.03906,1.08984c0.75149,1.25092 1.32146,2.61583 1.68555,4.07031c0.0969,0.38717 0.41473,0.67966 0.80859,0.74414l5.70703,0.93359v3.80859l-5.71875,1.00391c-0.3899,0.06902 -0.70237,0.36157 -0.79687,0.74609c-0.35988,1.45263 -0.93019,2.8175 -1.68164,4.06836c-0.20617,0.34256 -0.18851,0.775 0.04492,1.09961l3.37891,4.68945l-2.69336,2.69531l-4.74023,-3.32617c-0.32527,-0.22783 -0.75452,-0.24163 -1.09375,-0.03516c-1.24752,0.75899 -2.62251,1.33943 -4.08008,1.70898c-0.38168,0.09622 -0.67142,0.40737 -0.74023,0.79492l-1.00977,5.6875h-3.81445l-0.94141,-5.66211c-0.06549,-0.39365 -0.35874,-0.7107 -0.74609,-0.80664c-1.46338,-0.36069 -2.84314,-0.93754 -4.10547,-1.69531c-0.33857,-0.20276 -0.76473,-0.18746 -1.08789,0.03906l-4.70312,3.29492l-2.69531,-2.69922l3.32422,-4.64648c0.23221,-0.3254 0.24834,-0.75782 0.04102,-1.09961c-0.76602,-1.26575 -1.34535,-2.6454 -1.71094,-4.11523c-0.09555,-0.38244 -0.40684,-0.67307 -0.79492,-0.74219l-5.63086,-1v-3.81445l5.62695,-0.93555c0.39312,-0.06519 0.71002,-0.35754 0.80664,-0.74414c0.36873,-1.4749 0.94778,-2.85432 1.71094,-4.11719c0.20562,-0.33876 0.19183,-0.76697 -0.03516,-1.0918l-3.28516,-4.69531l2.69727,-2.69531l4.66211,3.33203c0.32413,0.23112 0.75447,0.248 1.0957,0.04297c1.25566,-0.75415 2.63862,-1.32636 4.10352,-1.68555c0.38927,-0.09584 0.68369,-0.41486 0.74805,-0.81055zM25,17c-4.40643,0 -8,3.59357 -8,8c0,4.40643 3.59357,8 8,8c4.40643,0 8,-3.59357 8,-8c0,-4.40643 -3.59357,-8 -8,-8zM25,19c3.32555,0 6,2.67445 6,6c0,3.32555 -2.67445,6 -6,6c-3.32555,0 -6,-2.67445 -6,-6c0,-3.32555 2.67445,-6 6,-6z"></path></g></g>
</svg>&nbsp;
                    <span>Settings</span>
                </a>
            </li>
        </ul>
    </div>

<script src="auth.js"></script>
<script>
        async function loadAdminGrievances(){
            try{
                const res = await authFetch('http://localhost:8080/api/grievances');
                if(!res.ok) throw new Error('Failed');
                const data = await res.json();
                    const tbody = document.querySelector('.grievance-section tbody');
                    if (!tbody) { console.warn('loadAdminGrievances: .grievance-section tbody not found'); return; }
                    tbody.innerHTML = '';
                data.forEach(g => {
                                        const tr = document.createElement('tr');
                                        const status = (g.status || 'PENDING').toString().toUpperCase();
                                        const displayStatus = status === 'IN_REVIEW' ? 'In Review' : status === 'INVESTIGATING' ? 'Investigating' : status === 'RESOLVED' ? 'Resolved' : status === 'PENDING' ? 'Pending' : status;
                                            tr.innerHTML = `
                                                    <td>${g.id}</td>
                                                    <td>${g.title || ''} ${g.images && g.images.length ? `<div style="font-size:12px;color:#666; margin-top:6px;">Images: ${g.images.length}</div>` : ''}</td>
                                                    <td>${g.user ? g.user.name || g.user.email : ''}</td>
                                                    <td>${g.user ? g.user.role : ''}</td>
                                                    <td>${g.createdAt ? g.createdAt.split('T')[0] : ''}</td>
                                                    <td><span class="status-${status.toLowerCase().replace(/_/g,'-')} status-tag">${displayStatus}</span></td>
                                                    <td>${g.feedback ? (g.feedback.length>60 ? g.feedback.substring(0,60)+'...' : g.feedback) : '-'}</td>
                                                    <td>
                                                        <select data-id="${g.id}" class="status-select">
                                                            <option value="PENDING">Pending</option>
                                                            <option value="IN_REVIEW">In Review</option>
                                                            <option value="INVESTIGATING">Investigating</option>
                                                            <option value="RESOLVED">Resolved</option>
                                                            <option value="CLOSED">Closed</option>
                                                        </select>
                                                        <button class="update-status">Update</button>
                                                    </td>
                                            `;
                    tbody.appendChild(tr);
                                        // set the select to current status code
                                        const sel = tr.querySelector('.status-select');
                                        if (sel) sel.value = status;
                });

                document.querySelectorAll('.update-status').forEach(btn=>{
                    btn.addEventListener('click', async (ev)=>{
                        const sel = ev.target.previousElementSibling;
                        const id = sel.getAttribute('data-id');
                        const status = sel.value;
                        try{
                            const r = await authFetch('http://localhost:8080/api/grievances/'+id+'/status?status='+encodeURIComponent(status), { method: 'PUT' });
                            if(!r.ok){ const t = await r.text().catch(()=>null); throw new Error(r.status+' '+t); }
                            alert('Updated');
                            await loadAdminGrievances();
                        }catch(e){ console.error(e); alert('Update failed: '+e.message); }
                    });
                });

            }catch(e){ console.error('loadAdminGrievances', e); }
        }

        document.addEventListener('DOMContentLoaded', loadAdminGrievances);
    </script>

    <div class="main-content">
        
        <div class="header">
            <h1>Analytics Overview</h1>
            <div class="user-info">
                <span>Welcome, Admin User</span>
                <a href="home.html" class="logout-btn" style="margin-left: 15px;">Logout</a>
            </div>
        </div>

        <div class="widgets-grid">
            
            <div class="widget total">
                <div class="widget-content">
                    <h3>Total Grievances</h3>
                    <p><span id="stat-total">0</span></p>
                </div>
                <div class="widget-icon">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
                </div>
            </div>

            <div class="widget pending">
                <div class="widget-content">
                    <h3>Pending Grievances</h3>
                    <p><span id="stat-pending">0</span></p>
                </div>
                <div class="widget-icon">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd"></path></svg>
                </div>
            </div>

            <div class="widget resolved">
                <div class="widget-content">
                    <h3>Resolved This Month</h3>
                    <p><span id="stat-resolved-month">0</span></p>
                </div>
                <div class="widget-icon">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                </div>
            </div>

            <div class="widget users">
                <div class="widget-content">
                    <h3>Active Users</h3>
                    <p><span id="stat-active-users">0</span></p>
                </div>
                <div class="widget-icon">
                    <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 00-2-2h-2a2 2 0 00-2 2v1h-2V8a2 2 0 00-2-2H4a2 2 0 00-2 2v1H0v2h1v1a10 10 0 001 3v1a2 2 0 002 2h12a2 2 0 002-2v-1a10 10 0 001-3v-1h1v-2h-2V8z"></path></svg>
                </div>
            </div>

        </div>
        <div class="grievance-section" id="complaints-section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <h2 style="margin:0">Recent Grievances</h2>
                <div class="muted">Last updated: <span id="last-updated">--</span></div>
            </div>

            <div class="toolbar">
                <div class="search">
                    <input id="admin-search" type="search" placeholder="Search by subject, id or reporter...">
                    <select id="admin-status-filter">
                        <option value="">All Statuses</option>
                        <option value="PENDING">Pending</option>
                        <option value="IN_REVIEW">In Review</option>
                        <option value="INVESTIGATING">Investigating</option>
                        <option value="RESOLVED">Resolved</option>
                        <option value="CLOSED">Closed</option>
                    </select>
                </div>
                <div class="actions">
                    <button id="refresh-btn" class="small-btn gray">Refresh</button>
                    <!-- <button id="export-btn" class="small-btn secondary">Export CSV</button> -->
                </div>
            </div>

            <table class="grievance-table">
                <thead>
                    <tr>
                        <th style="width:60px">ID</th>
                        <th>Subject</th>
                        <th style="width:180px">Reported By</th>
                        <th style="width:90px">Role</th>
                        <th style="width:120px">Date</th>
                        <th style="width:140px">Status</th>
                        <th style="width:220px">Feedback</th>
                        <th style="width:220px">Action</th>
                    </tr>
                </thead>
                <tbody id="admin-tbody">
                </tbody>
            </table>
        </div>
    </div>

</body>
</html>
<script>
    // keep existing load behavior but render into a buffer so we can filter/search
    let adminData = [];

    async function loadAdminGrievances(){
        try{
            const res = await authFetch('http://localhost:8080/api/grievances');
            if(!res.ok) { const t = await res.text().catch(()=>null); console.error('loadAdminGrievances: fetch failed', res.status, t); throw new Error('Failed: '+res.status); }
            const data = await res.json();
            console.log('loadAdminGrievances: got', data && data.length ? data.length + ' grievances' : 'no grievances', data && data[0] ? { sample: data[0], sampleImages: (data[0].images || []).slice(0,3) } : null);
            adminData = data.map(g => ({
                id: g.id,
                title: g.title || '',
                reporter: g.user ? (g.user.name || g.user.email) : '',
                role: g.user ? g.user.role : '',
                createdAt: g.createdAt ? g.createdAt.split('T')[0] : '',
                status: (g.status || 'PENDING').toString().toUpperCase(),
                feedback: g.feedback || '',
                images: g.images || []
            }));
            // populate dashboard stats from the fetched data
            try {
                const total = adminData.length;
                const pending = adminData.filter(x => (x.status||'').toUpperCase() === 'PENDING').length;
                const now = new Date();
                const curY = now.getFullYear();
                const curM = now.getMonth() + 1; // 1-12
                const resolvedThisMonth = adminData.filter(x => {
                    if ((x.status||'').toUpperCase() !== 'RESOLVED') return false;
                    if (!x.createdAt) return false;
                    const parts = x.createdAt.split('-');
                    if (parts.length < 2) return false;
                    const y = parseInt(parts[0], 10);
                    const m = parseInt(parts[1], 10);
                    return y === curY && m === curM;
                }).length;
                const reporters = new Set(adminData.map(x => (x.reporter||'').toString().trim()).filter(s => s));
                const activeUsers = reporters.size;
                const el = id => document.getElementById(id);
                if (el('stat-total')) el('stat-total').textContent = total;
                if (el('stat-pending')) el('stat-pending').textContent = pending;
                if (el('stat-resolved-month')) el('stat-resolved-month').textContent = resolvedThisMonth;
                if (el('stat-active-users')) el('stat-active-users').textContent = activeUsers;
            } catch (se) { console.warn('Could not populate stats', se); }

            document.getElementById('last-updated').textContent = new Date().toLocaleString();
            renderAdminTable();
        }catch(e){ console.error('loadAdminGrievances', e); }
    }

    function renderAdminTable(){
        const tbody = document.getElementById('admin-tbody');
        const q = (document.getElementById('admin-search').value || '').toLowerCase();
        const statusFilter = document.getElementById('admin-status-filter').value;
        tbody.innerHTML = '';

        const filtered = adminData.filter(g => {
            if (statusFilter && g.status !== statusFilter) return false;
            if (!q) return true;
            return (g.title||'').toLowerCase().includes(q) || (g.reporter||'').toLowerCase().includes(q) || (''+g.id).includes(q);
        });

        filtered.forEach(g => {
            const tr = document.createElement('tr');
            const displayStatus = g.status === 'IN_REVIEW' ? 'In Review' : g.status === 'INVESTIGATING' ? 'Investigating' : g.status === 'RESOLVED' ? 'Resolved' : g.status === 'CLOSED' ? 'Closed' : g.status === 'PENDING' ? 'Pending' : g.status;
            tr.innerHTML = `
                <td>${g.id}</td>
                <td>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="flex:1">${g.title}</div>
                        ${g.images && g.images.length ? `<div style="display:flex;align-items:center;gap:6px"><div style="width:64px;height:44px;overflow:hidden;border-radius:6px;border:1px solid #eee;cursor:pointer" onclick="viewDetails(${g.id})"><img src="${g.images[0]}" style="width:100%;height:100%;object-fit:cover"/></div><div style="font-size:12px;color:#666;">Images: ${g.images.length}</div></div>` : ''}
                    </div>
                </td>
                <td class="muted">${g.reporter}</td>
                <td>${g.role}</td>
                <td>${g.createdAt}</td>
                <td><span class="status-badge" style="background:${g.status==='PENDING'?'#f39c12':g.status==='RESOLVED'?'#2ecc71':g.status==='CLOSED'?'#27ae60':'#3498db'}">${displayStatus}</span></td>
                <td>${g.feedback? (g.feedback.length>80? g.feedback.substring(0,80)+'...': g.feedback) : '-'}</td>
                <td>
                    <select data-id="${g.id}" class="status-select">
                        <option value="PENDING">Pending</option>
                        <option value="IN_REVIEW">In Review</option>
                        <option value="INVESTIGATING">Investigating</option>
                        <option value="RESOLVED">Resolved</option>
                        <option value="CLOSED">Closed</option>
                    </select>
                    <button class="small-btn primary update-status">Update</button>
                    ${g.images && g.images.length ? `<button class="small-btn gray" onclick="viewDetails(${g.id})" style="margin-left:6px;">View Images</button>` : ''}
                </td>
            `;
            tbody.appendChild(tr);
            const sel = tr.querySelector('.status-select'); if (sel) sel.value = g.status;
        });

        document.querySelectorAll('.update-status').forEach(btn=>{
            btn.addEventListener('click', async (ev)=>{
                const sel = ev.target.previousElementSibling;
                const id = sel.getAttribute('data-id');
                const status = sel.value;
                try{
                    const r = await authFetch('http://localhost:8080/api/grievances/'+id+'/status?status='+encodeURIComponent(status), { method: 'PUT' });
                    if(!r.ok){ const t = await r.text().catch(()=>null); throw new Error(r.status+' '+t); }
                    await loadAdminGrievances();
                }catch(e){ console.error(e); alert('Update failed: '+e.message); }
            });
        });
    }

    function viewDetails(id){
        const r = adminData.find(x => (''+x.id) === (''+id));
        if (!r) { alert('Not found'); return; }
        const w = window.open('', '_blank', 'width=800,height=600');
        const html = [];
        html.push('<!doctype html><html><head><title>Grievance '+r.id+'</title></head><body style="font-family:Arial,sans-serif; padding:16px">');
        html.push('<h2>Grievance '+r.id+': '+(r.title||'')+'</h2>');
        html.push('<p><strong>Reported By:</strong> '+(r.reporter||'')+' ('+(r.role||'')+')<br/><strong>Date:</strong> '+(r.createdAt||'')+'</p>');
        if (r.images && r.images.length){
            html.push('<h3>Images</h3><div style="display:flex; gap:8px; flex-wrap:wrap">');
            r.images.forEach(src=> html.push('<div style="width:160px;height:100px;overflow:hidden;border:1px solid #eee;border-radius:6px"><img src="'+src+'" style="width:100%;height:100%;object-fit:cover"/></div>'));
            html.push('</div>');
        } else {
            html.push('<p>No images attached.</p>');
        }
        html.push('<p><strong>Feedback:</strong> '+(r.feedback||'-')+'</p>');
        html.push('</body></html>');
        w.document.write(html.join(''));
        w.document.close();
    }

    const adminSearchEl = document.getElementById('admin-search'); if (adminSearchEl) adminSearchEl.addEventListener('input', renderAdminTable);
    const adminFilterEl = document.getElementById('admin-status-filter'); if (adminFilterEl) adminFilterEl.addEventListener('change', renderAdminTable);
    const refreshBtn = document.getElementById('refresh-btn'); if (refreshBtn) refreshBtn.addEventListener('click', loadAdminGrievances);
    const exportBtn = document.getElementById('export-btn'); if (exportBtn) exportBtn.addEventListener('click', ()=>{ alert('Export not implemented (placeholder)'); });

    document.addEventListener('DOMContentLoaded', loadAdminGrievances);
</script>
