<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patient Dashboard | HGS</title>

<style>
/* ---------------- GLOBAL ---------------- */
* { box-sizing: border-box; }

body {
    font-family: "Segoe UI", Arial, sans-serif;
    margin: 0;
    background: linear-gradient(135deg, #f4f7f6, #eef2f3);
    color: #333;
    display: flex;
    min-height: 100vh;
}

/* -------- Image Upload Box -------- */
.upload-area{
    border:2px dashed #2ecc71;
    border-radius:10px;
    padding:18px;
    text-align:center;
    font-weight:600;
    color:#2ecc71;
    cursor:pointer;
    transition:.25s;
    background:#f6fffb;
}
.upload-area:hover{
    background:#eafff6;
}
.upload-area.dragover{
    background:#e8fff3;
    border-color:#27ae60;
    color:#27ae60;
}


/* ---------------- SIDEBAR ---------------- */

#myVideo {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 0;
    pointer-events: none;
}


.sidebar {
    width: 250px;
    color: white;
    padding-top: 20px;
    position: fixed;
    height: 100%;
    overflow: hidden;
    box-shadow: 4px 0 12px rgba(0,0,0,0.15);
    background: rgba(44, 62, 80, 0.75);
}
.sidebar-content {
    position: relative;
    z-index: 2;
}



.sidebar h2 { text-align:center; margin-bottom:20px; color:#2ecc71; }
.sidebar a { display:flex; align-items:center; padding:12px 18px; color:white; text-decoration:none; }
.sidebar a:hover, .sidebar a.active { background: rgba(255,255,255,0.04); color:#2ecc71; }

/* ---------------- MAIN CONTENT ---------------- */
.main-content { margin-left: 250px; flex-grow:1; padding: 24px; }

.header { background: white; padding: 14px 18px; border-radius:8px; box-shadow:0 6px 14px rgba(0,0,0,0.06); margin-bottom:18px; display:flex; justify-content:space-between; align-items:center; }
.header h1 { margin:0; font-size:20px; }

/* shared logout button */
.logout-btn { display:inline-block; padding:8px 12px; border-radius:6px; color:#555; text-decoration:none; border:1px solid #ddd; background:transparent; }
.logout-btn:hover{ background:#2ecc71; color:#fff; border-color:#2ecc71; }

/* ---------------- CARDS & FORMS ---------------- */
.section-card { background:white; border-radius:12px; padding:20px; box-shadow:0 8px 18px rgba(0,0,0,0.06); margin-bottom:22px; }
.section-card h2 { margin:0 0 12px; font-size:18px; border-bottom:1px solid #eee; padding-bottom:10px; }

.form-group label { font-weight:600; display:block; margin-bottom:9px; }
.form-group input, .form-group select, .form-group textarea { width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; }
.submit-btn { padding:10px 16px; border-radius:8px; border:none; cursor:pointer; font-weight:600; margin-top: 12px;}
.primary-green { background:#2ecc71; color:white; }

/* tables */
.grievance-table { width:100%; border-collapse:collapse; }
.grievance-table th, .grievance-table td { padding:12px 10px; border-bottom:1px solid #f0f0f0; }
.status-tag { padding:6px 10px; border-radius:999px; font-weight:700; color:white; }
.status-pending { background:#f39c12; }
.status-in-review { background:#3498db; }
.status-resolved { background:#2ecc71; }
.status-closed { background:#e74c3c; }
.status-investigating { background:#9b59b6; }
.feedback-btn { padding:6px 12px; border:none; border-radius:8px; background:#3498db; color:white; cursor:pointer; font-weight:600; }

/* small helpers */
.toolbar { display:flex; gap:10px; align-items:center; margin-bottom:12px; }
.muted { color:#777; }

/* responsive */
/* ================= PATIENT DASHBOARD RESPONSIVE ================= */

/* Large tablets */
@media (max-width: 1024px) {
    .sidebar { width: 200px; }
    .main-content { margin-left: 200px; padding: 16px; }
    .header h1 { font-size: 18px; }
}

/* Tablets */
@media (max-width: 900px) {
    .section-card { padding: 14px; }
    .toolbar { flex-direction: column; gap: 10px; }
    .toolbar .search { width: 100%; }
    .grievance-table th, .grievance-table td { padding: 9px; font-size: 13px; }
    .status-tag { font-size: 11px; padding: 5px 8px; }
}

/* Mobile */
@media (max-width: 700px) {

    body { flex-direction: column; }

    .sidebar {
        position: relative;
        width: 100%;
        height: 100px;
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 8px 10px;
    }

    .sidebar-content {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .sidebar h2 {
        margin-right: 120px;
        font-size: 15px;
        white-space: nowrap;
    }

    .sidebar a {
        padding: 6px 8px;
        font-size: 13px;
    }

    .main-content {
        margin-left: 0;
        padding: 12px;
    }

    .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }

    .section-card h2 { font-size: 16px; }

    .grievance-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }

    .submit-btn, .feedback-btn {
        font-size: 13px;
        padding: 8px 12px;
    }
}

/* Small phones */
@media (max-width: 420px) {

    .sidebar-content {
        flex-wrap: wrap;
        justify-content: center;
    }

    .sidebar a {
        font-size: 12px;
        padding: 5px 6px;
    }
    .sidebar span {
        display: none;
    }

    .header h1 { font-size: 16px; }

    .status-tag { font-size: 10px; }
}

.table-responsive { overflow-x:auto; -webkit-overflow-scrolling:touch; }

/* ---------- Modal & Timeline & Rating (restored) ---------- */
.modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index:1000; }
.modal-content { background:white; max-width:720px; margin:60px auto; padding:22px; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,0.12); }
.timeline { display:flex; justify-content:space-between; gap:12px; margin:18px 0 22px; position:relative; padding-top:18px; }
.timeline::before { content:''; position:absolute; top:32px; left:0; right:0; height:4px; background:#e6e6e6; border-radius:4px; }
.timeline-step { flex:1; text-align:center; position:relative; z-index:1; color:#888; font-size:13px; }
.timeline-circle { width:18px; height:18px; border-radius:50%; background:#ccc; margin:0 auto 8px; border:4px solid white; box-shadow:0 0 0 2px #ccc; transition:all .25s; }
.timeline-step.active { color:#2ecc71; font-weight:600; }
.timeline-step.active .timeline-circle { background:#2ecc71; box-shadow:0 0 0 3px rgba(46,204,113,0.28); }
.rating-stars span { font-size:28px; cursor:pointer; color:#ccc; margin-right:4px; }
.rating-stars span.active { color:#f1c40f; }

/* upload preview small helpers */
#image-previews { display:flex; gap:8px; margin-top:8px; }
#image-previews .thumb { width:76px; height:56px; position:relative; overflow:hidden; border:1px solid #eee; border-radius:6px; }
#image-previews .thumb img{ width:100%; height:100%; object-fit:cover; }
#image-previews .thumb button{ position:absolute; top:4px; right:4px; background:rgba(0,0,0,0.5); color:white; border:none; border-radius:6px; padding:2px 6px; cursor:pointer; }


</style>
</head>

<body>

    <div class="sidebar">

    <video autoplay muted loop playsinline preload="auto" id="myVideo">
        <source src="login bg video.mp4" type="video/mp4">
    </video>

    <div class="sidebar-content">
        <h2>HGS Patient</h2>
        <a href="#submission-section" class="active">
            <svg fill="currentColor" x="0px" y="0px" width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
            &nbsp;
            <span>Dashboard</span></a>
        <a href="#list-section">
            <svg fill="currentColor" x="0px" y="0px" width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>&nbsp;
            <span>My Grievances</span></a>
        <a href="settings_patient.html">
           <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="20" height="20" viewBox="0,0,256,256">
<g fill="#fef9f9" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><g transform="scale(5.12,5.12)"><path d="M22.20508,2c-0.48953,0.00026 -0.90693,0.35484 -0.98633,0.83789l-0.97266,5.95508c-1.16958,0.34023 -2.28485,0.7993 -3.33594,1.37109l-4.91406,-3.50977c-0.39728,-0.28369 -0.94131,-0.23911 -1.28711,0.10547l-3.89062,3.88672c-0.3432,0.34344 -0.39015,0.88376 -0.11133,1.28125l3.45703,4.94531c-0.58061,1.05722 -1.04985,2.17878 -1.39844,3.35938l-5.92969,0.98633c-0.4815,0.0811 -0.83404,0.49805 -0.83398,0.98633v5.5c-0.00088,0.48518 0.3466,0.901 0.82422,0.98633l5.93359,1.05078c0.3467,1.17855 0.81296,2.30088 1.39453,3.35937l-3.5,4.89648c-0.28369,0.39728 -0.23911,0.94131 0.10547,1.28711l3.88867,3.89063c0.34265,0.34275 0.88175,0.39048 1.2793,0.11328l4.95508,-3.46875c1.05419,0.57517 2.17218,1.03762 3.3457,1.38086l0.99023,5.96289c0.08025,0.48228 0.49742,0.83584 0.98633,0.83594h5.5c0.4858,0.00071 0.90184,-0.34778 0.98633,-0.82617l1.06055,-5.98633c1.16868,-0.3485 2.28142,-0.8178 3.33008,-1.39648l4.98828,3.5c0.39749,0.27882 0.93781,0.23187 1.28125,-0.11133l3.88867,-3.89258c0.34612,-0.34687 0.38995,-0.89343 0.10352,-1.29102l-3.55664,-4.9375c0.56867,-1.04364 1.02681,-2.14972 1.36719,-3.31055l6.01758,-1.05469c0.47839,-0.08448 0.82689,-0.50053 0.82617,-0.98633v-5.5c-0.00026,-0.48953 -0.35484,-0.90693 -0.83789,-0.98633l-6.00781,-0.98242c-0.34266,-1.15945 -0.80206,-2.26356 -1.37109,-3.30664l3.50781,-4.99805c0.27882,-0.39749 0.23187,-0.93781 -0.11133,-1.28125l-3.89062,-3.88867c-0.34687,-0.34612 -0.89343,-0.38995 -1.29102,-0.10352l-4.92383,3.54102c-1.04908,-0.57636 -2.16255,-1.04318 -3.33398,-1.38867l-1.04687,-5.98437c-0.08364,-0.47917 -0.49991,-0.82867 -0.98633,-0.82812zM23.05664,4h3.80859l0.99609,5.68555c0.06772,0.38959 0.35862,0.70269 0.74219,0.79883c1.46251,0.36446 2.83609,0.94217 4.08984,1.70117c0.34265,0.20761 0.77613,0.1907 1.10156,-0.04297l4.67969,-3.36328l2.69336,2.69336l-3.33203,4.74805c-0.22737,0.3236 -0.24268,0.75079 -0.03906,1.08984c0.75149,1.25092 1.32146,2.61583 1.68555,4.07031c0.0969,0.38717 0.41473,0.67966 0.80859,0.74414l5.70703,0.93359v3.80859l-5.71875,1.00391c-0.3899,0.06902 -0.70237,0.36157 -0.79687,0.74609c-0.35988,1.45263 -0.93019,2.8175 -1.68164,4.06836c-0.20617,0.34256 -0.18851,0.775 0.04492,1.09961l3.37891,4.68945l-2.69336,2.69531l-4.74023,-3.32617c-0.32527,-0.22783 -0.75452,-0.24163 -1.09375,-0.03516c-1.24752,0.75899 -2.62251,1.33943 -4.08008,1.70898c-0.38168,0.09622 -0.67142,0.40737 -0.74023,0.79492l-1.00977,5.6875h-3.81445l-0.94141,-5.66211c-0.06549,-0.39365 -0.35874,-0.7107 -0.74609,-0.80664c-1.46338,-0.36069 -2.84314,-0.93754 -4.10547,-1.69531c-0.33857,-0.20276 -0.76473,-0.18746 -1.08789,0.03906l-4.70312,3.29492l-2.69531,-2.69922l3.32422,-4.64648c0.23221,-0.3254 0.24834,-0.75782 0.04102,-1.09961c-0.76602,-1.26575 -1.34535,-2.6454 -1.71094,-4.11523c-0.09555,-0.38244 -0.40684,-0.67307 -0.79492,-0.74219l-5.63086,-1v-3.81445l5.62695,-0.93555c0.39312,-0.06519 0.71002,-0.35754 0.80664,-0.74414c0.36873,-1.4749 0.94778,-2.85432 1.71094,-4.11719c0.20562,-0.33876 0.19183,-0.76697 -0.03516,-1.0918l-3.28516,-4.69531l2.69727,-2.69531l4.66211,3.33203c0.32413,0.23112 0.75447,0.248 1.0957,0.04297c1.25566,-0.75415 2.63862,-1.32636 4.10352,-1.68555c0.38927,-0.09584 0.68369,-0.41486 0.74805,-0.81055zM25,17c-4.40643,0 -8,3.59357 -8,8c0,4.40643 3.59357,8 8,8c4.40643,0 8,-3.59357 8,-8c0,-4.40643 -3.59357,-8 -8,-8zM25,19c3.32555,0 6,2.67445 6,6c0,3.32555 -2.67445,6 -6,6c-3.32555,0 -6,-2.67445 -6,-6c0,-3.32555 2.67445,-6 6,-6z"></path></g></g>
</svg>&nbsp;
            <span>Setting</span> </a> 
    </div>

</div>


    <div class="main-content">
        <div class="header">
            <h1>Patient Dashboard</h1>
            <div style="display:flex; align-items:center; gap:12px;">
                <div class="user-info">
                    <div id="nav-user-name" style="font-weight:700;">Patient User</div>
                </div>
                <a class="logout-btn" href="index.html">Logout</a>
            </div>
        </div>
        

        <!-- New: Quick Actions & Recent Activity
        <div class="section-card" style="display:grid; grid-template-columns: 1fr 360px; gap:20px; align-items:start;">
            <div>
                <h2 style="margin-bottom:12px;">Quick Actions</h2>
                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <button class="submit-btn primary-green" onclick="document.getElementById('grievance-subject').focus();">Submit Grievance</button>
                    <button class="submit-btn" style="background:#f39c12; color:white;" onclick="document.getElementById('search-input').value=''; renderGrievanceList();">Show Open Cases</button>
                    <a href="mailto:support@example.com" class="submit-btn" style="background:#3498db; color:white; display:inline-flex; align-items:center; gap:8px; text-decoration:none;">Contact Support</a>
                    <button class="submit-btn" style="background:#6c757d; color:white;" onclick="window.scrollTo({top: document.getElementById('list-section').offsetTop-40, behavior:'smooth'})">Go To My Grievances</button>
                </div>
                <div style="margin-top:18px;">
                    <label style="font-weight:700; color:#444; display:block; margin-bottom:8px;">Search results:</label>
                    <div id="search-summary" class="muted">Showing all grievances</div>
                </div>
            </div>

            <div>
                <h2 style="margin-bottom:12px;">Recent Activity</h2>
                <div id="recent-activity" style="max-height:220px; overflow:auto; padding-right:6px;">
                    <div class="muted">No recent activity</div>
                </div>
            </div>
        </div> -->
        
        <div id="submission-section" class="section-card">
            <h2>üìù Submit a New Grievance</h2>
            <form id="grievance-form">

                <!-- New: image upload area (max 3 images, images only) -->
                <div class="form-group">
                    <label for="grievance-images">Upload up to 3 photos (images only)</label>
                    <div id="upload-area" class="upload-area" tabindex="0">Drag & drop images here or click to select</div>
                    <input type="file" id="grievance-images" accept="image/*" multiple style="display:none">
                    <div id="image-previews" class="thumbs" aria-live="polite"></div>
                    <p id="upload-error" style="color:#e74c3c; display:none; margin-top:8px; font-size:13px;"></p>
                </div>

                
                <div class="form-group">
                    <label for="grievance-subject">Subject (Brief Summary)</label>
                    <input type="text" id="grievance-subject" required maxlength="100">
                </div>

                <div class="form-group">
                    <label for="grievance-category">Category</label>
                    <select id="grievance-category" required>
                        <option value="" disabled selected>Select a category</option>
                        <option value="Care Quality">Care Quality (e.g., Treatment, Mistakes)</option>
                        <option value="Staff Conduct">Staff Conduct (e.g., Attitude, Communication)</option>
                        <option value="Facilities">Facilities (e.g., Cleanliness, Maintenance)</option>
                        <option value="Billing">Billing & Insurance</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="grievance-details">Details of the Grievance</label>
                    <textarea id="grievance-details" rows="5" required placeholder="Describe your experience, including date and location, if possible."></textarea>
                </div>

                <div class="form-group">
                    <label for="grievance-anonymity">Reporting Anonymity</label>
                    <select id="grievance-anonymity" required>
                        <option value="No">Report with my name (Recommended)</option>
                        <option value="Yes">Report Anonymously</option>
                    </select>
                </div>
                
                <button type="submit" class="submit-btn primary-green hover-green">Submit Grievance</button>
            </form>
        </div>

        <!-- Quick controls: search + summary -->
        <div class="section-card" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
            <div style="flex:1; min-width:220px;">
                <div class="toolbar">
                    <div class="search" style="flex:1;">
                        <input id="search-input" type="search" placeholder="Search by subject, category or ID..." style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;" />
                        <select id="patient-status-filter" style="margin-left:10px;">
                            <option value="">All Statuses</option>
                            <option value="Pending">Pending</option>
                            <option value="In Review">In Review</option>
                            <option value="Investigating">Investigating</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                </div>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <div style="font-size:14px; color:#555">Total: <strong id="count-total">0</strong></div>
                <div style="font-size:14px; color:#555">Pending: <strong id="count-pending">0</strong></div>
                <div style="font-size:14px; color:#555">In Review: <strong id="count-in-review">0</strong></div>
                <div style="font-size:14px; color:#555">Resolved: <strong id="count-resolved">0</strong></div>
                <div style="font-size:14px; color:#555">Closed: <strong id="count-closed">0</strong></div>
            </div>
        </div>

        <div id="list-section" class="section-card">
            <h2>‚è±Ô∏è My Submitted Grievances</h2>
            <table class="grievance-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Subject</th>
                        <th>Category</th>
                        <th>Submitted Date</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="my-grievance-list">
                    </tbody>
            </table>
            <p id="no-grievances-msg" style="text-align: center; color: #777; margin-top: 20px; display: none;">You haven't submitted any grievances yet.</p>
        </div>

    <div id="status-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-primary-green" style="margin-top: 0;">Grievance Status</h3>
            
            <h4>Resolution Timeline</h4>
            <div id="timeline" class="timeline">
                </div>

            <h4>Communication Log</h4>
            <div id="communication-log" style="border: 1px solid #ccc; padding: 15px; height: 150px; overflow-y: scroll; margin-bottom: 15px; font-size: 14px;">
                </div>
            
            <button onclick="closeModal('status-modal')" class="submit-btn" style="background-color: #6c757d;">Close</button>
        </div>
    </div>
    
    <div id="feedback-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-primary-green" style="margin-top: 0;">Rate Resolution for <span id="feedback-id"></span></h3>
            
            <div class="form-group">
                <label>Overall Satisfaction Rating:</label>
                <div id="rating-container" class="rating-stars" data-rating="0">
                    <span data-value="1" onclick="setRating(1)">‚òÖ</span>
                    <span data-value="2" onclick="setRating(2)">‚òÖ</span>
                    <span data-value="3" onclick="setRating(3)">‚òÖ</span>
                    <span data-value="4" onclick="setRating(4)">‚òÖ</span>
                    <span data-value="5" onclick="setRating(5)">‚òÖ</span>
                </div>
            </div>

            <div class="form-group">
                <label for="feedback-comment">Comments on Resolution (Optional)</label>
                <textarea id="feedback-comment" rows="4" placeholder="How satisfied were you with the investigation and outcome?"></textarea>
            </div>
            
            <button onclick="submitFeedback()" class="submit-btn primary-green hover-green">Submit Rating & Close</button>
            <button onclick="closeModal('feedback-modal')" class="submit-btn" style="background-color: #6c757d; margin-left: 10px;">Cancel</button>
        </div>
    </div>

    </div>

    <script src="auth.js"></script>
    <script>
        // --- Simulated Database (Client-Side Storage) ---
        let patientGrievances = [
            { 
                id: 'HGS-001', 
                subject: 'Parking Lot Security', 
                category: 'Facilities', 
                date: '2025-11-15', 
                status: 'In Review', 
                anonymity: 'No', 
                log: [
                    { step: 'Submitted', message: 'Grievance submitted successfully.', timestamp: '2025-11-15 09:00' },
                    { step: 'Assigned', message: 'Assigned to Maintenance Dept.', timestamp: '2025-11-16 10:30' },
                    { step: 'Investigating', message: 'Facility inspection scheduled.', timestamp: '2025-11-17 14:00' }
                ],
                feedback: null
            },
            { 
                id: 'HGS-002', 
                subject: 'Doctor Communication', 
                category: 'Care Quality', 
                date: '2025-11-10', 
                status: 'Resolved', 
                anonymity: 'Yes',
                log: [
                    { step: 'Submitted', message: 'Grievance submitted successfully.', timestamp: '2025-11-10 14:00' },
                    { step: 'Assigned', message: 'Assigned to Clinical Review Team.', timestamp: '2025-11-11 09:00' },
                    { step: 'Investigating', message: 'Staff interviews conducted.', timestamp: '2025-11-12 11:00' },
                    { step: 'Resolved', message: 'Review complete. New communication protocol established.', timestamp: '2025-11-14 16:30' }
                ],
                feedback: null // feedback: { rating: 5, comment: "Excellent service." } would be stored here
            },
            { 
                id: 'HGS-003', 
                subject: 'Billing Error', 
                category: 'Billing', 
                date: '2025-11-18', 
                status: 'Closed', 
                anonymity: 'No',
                log: [
                    { step: 'Submitted', message: 'Grievance submitted successfully.', timestamp: '2025-11-18 10:00' },
                    { step: 'Assigned', message: 'Assigned to Finance Dept.', timestamp: '2025-11-18 11:00' },
                    { step: 'Investigating', message: 'Error corrected and refund issued.', timestamp: '2025-11-19 15:00' },
                    { step: 'Resolved', message: 'Issue officially resolved.', timestamp: '2025-11-19 16:00' }
                ],
                feedback: { rating: 4, comment: "Billing was slow, but the resolution was fast and fair." }
            },
            { 
                id: 'HGS-004', 
                subject: 'Billing Error', 
                category: 'Billing', 
                date: '2025-11-18', 
                status: 'Investigating', 
                anonymity: 'No',
                log: [
                    { step: 'Submitted', message: 'Grievance submitted successfully.', timestamp: '2025-11-18 10:00' },
                    { step: 'Assigned', message: 'Assigned to Finance Dept.', timestamp: '2025-11-18 11:00' },
                    { step: 'Investigating', message: 'Error corrected and refund issued.', timestamp: '2025-11-19 15:00' },
                    { step: 'Resolved', message: 'Issue officially resolved.', timestamp: '2025-11-19 16:00' }
                ],
                feedback: { rating: 4, comment: "Billing was slow, but the resolution was fast and fair." }
            }
        ];
        // Ensure existing sample entries have images array
        patientGrievances = patientGrievances.map(function(g){ g.images = g.images || []; return g; });
        
        // Timeline Steps Definition
        const timelineSteps = ['Submitted', 'Assigned', 'Investigating', 'Resolved', 'Closed'];

        // --- Helper: image handling utilities ---
        const MAX_IMAGES = 3;
        function isImageFile(file) {
            return file && file.type && file.type.startsWith('image/');
        }

        // State for current upload (data URLs)
        let currentUploadData = [];

        function updatePreviews() {
            const container = document.getElementById('image-previews');
            if (container) {
                container.innerHTML = '';
            } else {
                console.warn('updatePreviews: #image-previews element not found');
                return;
            }
            currentUploadData.forEach((data, idx) => {
                const div = document.createElement('div');
                div.className = 'thumb';
                div.innerHTML = `<img src="${data}" alt="upload-${idx}" />`;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.title = 'Remove image';
                btn.textContent = '‚úï';
                btn.addEventListener('click', (e) => { e.stopPropagation(); currentUploadData.splice(idx,1); updatePreviews(); });
                div.appendChild(btn);
                container.appendChild(div);
            });
            document.getElementById('upload-error').style.display = 'none';
        }

        // Setup upload area interactions
        (function setupUploadArea(){
            const input = document.getElementById('grievance-images');
            const area = document.getElementById('upload-area');
            if (!input || !area) return;

            area.addEventListener('click', () => input.click());
            area.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') input.click(); });

            input.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files || []);
                await handleNewFiles(files);
                input.value = '';
            });

            ['dragenter','dragover'].forEach(ev => area.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); area.classList.add('dragover'); }));
            ['dragleave','drop','dragend'].forEach(ev => area.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); area.classList.remove('dragover'); }));
            area.addEventListener('drop', async (e) => {
                const files = Array.from(e.dataTransfer.files || []);
                await handleNewFiles(files);
            });
        })();

        async function handleNewFiles(files) {
            const errEl = document.getElementById('upload-error');
            // filter images
            const justImages = files.filter(isImageFile);
            if (justImages.length !== files.length) {
                errEl.textContent = 'Only image files are allowed.';
                errEl.style.display = 'block';
                return;
            }
            if (currentUploadData.length + justImages.length > MAX_IMAGES) {
                errEl.textContent = `Maximum ${MAX_IMAGES} images allowed.`;
                errEl.style.display = 'block';
                return;
            }
            // read files
            try {
                const datas = await Promise.all(justImages.map(f => readFileAsDataURL(f, 1200, 0.75)));
                currentUploadData.push(...datas);
                updatePreviews();
            } catch (e) {
                errEl.textContent = 'Error reading files.';
                errEl.style.display = 'block';
            }
        }

        // Read image File and resize to reduce payload. Returns dataURL.
        function readFileAsDataURL(file, maxWidth = 1200, quality = 0.75) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        // if image smaller than maxWidth, keep original dimensions
                        const ratio = img.width > maxWidth ? (maxWidth / img.width) : 1;
                        const w = Math.round(img.width * ratio);
                        const h = Math.round(img.height * ratio);
                        const canvas = document.createElement('canvas');
                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        // export as jpeg to reduce size
                        try {
                            const dataUrl = canvas.toDataURL('image/jpeg', quality);
                            resolve(dataUrl);
                        } catch (e) {
                            // fallback to original data
                            resolve(reader.result);
                        }
                    };
                    img.onerror = () => resolve(reader.result);
                    img.src = reader.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // --- Core Functions ---
        
        function renderGrievanceList() {
            const listBody = document.getElementById('my-grievance-list');
            if (!listBody) {
                console.warn('renderGrievanceList: #my-grievance-list element not found');
                return;
            }
            listBody.innerHTML = '';
            
            // Apply search filter
            const q = (document.getElementById('search-input')?.value || '').toLowerCase().trim();
            const filtered = patientGrievances.filter(g => {
                if (!q) return true;
                return (g.subject || '').toLowerCase().includes(q) || (g.category || '').toLowerCase().includes(q) || (g.id || '').toLowerCase().includes(q);
            });

            // Update counters
            updateCounts();

            if (filtered.length === 0) {
                document.getElementById('no-grievances-msg').style.display = 'block';
                return;
            }
            document.getElementById('no-grievances-msg').style.display = 'none';

            filtered.forEach(g => {
                const statusClass = g.status.toLowerCase().replace(' ', '-');
                const row = listBody.insertRow();
                row.style.cursor = 'default';
                
                let actionButton;

                // show feedback button when backend status indicates completion
                const rawStatus = (g._rawStatus || g.status || '').toString().toUpperCase();
                const isCompleted = rawStatus === 'COMPLETED' || rawStatus === 'RESOLVED';
                if (isCompleted && (!g.feedback || g.feedback === null)) {
                    // New Feature: Feedback button for Resolved cases
                    actionButton = `<button onclick="openFeedbackModal('${g.id}')" class="feedback-btn">Rate & Close</button>`;
                } else if (g.status === 'Closed') {
                    // New Feature: Show rating for Closed cases
                    actionButton = `<span style="font-size: 14px; color: #444;">Feedback given</span>`;
                } else {
                    actionButton = `<button onclick="openStatusModal('${g.id}')" style="border: none; background: none; cursor: pointer; color: #3498db; font-weight: bold;">View Status</button>`;
                }
                
                row.innerHTML = `
                    <td>${g.id}</td>
                    <td>${g.subject} ${g.images && g.images.length ? `<div style="font-size:12px;color:#666; margin-top:6px;">Images: ${g.images.length}</div>` : ''}</td>
                    <td>${g.category}</td>
                    <td>${g.date}</td>
                    <td><span class="status-tag status-${statusClass}">${g.status}</span></td>
                    <td>${actionButton}</td>
                `;
                // make row clickable to open status modal except for action button clicks
                row.addEventListener('click', (ev) => {
                    if (ev.target.tagName.toLowerCase() === 'button' || ev.target.closest('button')) return;
                    openStatusModal(g.id);
                });
            });
        }

        

        // --- Modal & Status Tracking Functions ---

        const openModal = (modalId) => {
             document.getElementById(modalId).style.display = 'block';
        }

        const closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
        }


        const openStatusModal = (id) => {
            const grievance = patientGrievances.find(g => g.id === id);
            if (!grievance) return;

            document.getElementById('modal-title').textContent = `Grievance ${id}: ${grievance.subject}`;
            
            // 1. Render Communication Log
            const logElement = document.getElementById('communication-log');
            if (logElement) {
                logElement.innerHTML = '';
            } else {
                console.warn('openStatusModal: #communication-log not found');
            }
            // Use reverse() to show latest message first in the log view
            grievance.log.slice().reverse().forEach(item => {
                const line = document.createElement('p');
                line.style.margin = '5px 0';
                line.style.fontSize = '14px';
                line.innerHTML = `<strong>[${item.timestamp}] (${item.step}):</strong> ${item.message}`;
                logElement.appendChild(line);
            });
            
            // 2. Render Timeline (Enhanced Feature)
            const timelineElement = document.getElementById('timeline');
            if (timelineElement) {
                timelineElement.innerHTML = '';
            } else {
                console.warn('openStatusModal: #timeline not found');
            }
            
            // Map display status to timeline step
function mapStatusToTimelineStep(status) {
    if (!status) return 'Submitted';

    switch (status) {
        case 'Pending':
            return 'Submitted';

        case 'In Review':
            return 'Assigned';

        case 'Investigating':
            return 'Investigating';

        case 'Resolved':
            return 'Resolved';

        case 'Closed':
            return 'Closed';

        default:
            return 'Submitted';
    }
}


const activeStep = mapStatusToTimelineStep(grievance.status);
const currentStepIndex = timelineSteps.indexOf(activeStep);

            
            timelineSteps.forEach((step, index) => {
                const isActive = index <= currentStepIndex;
                const stepDiv = document.createElement('div');
                stepDiv.className = `timeline-step ${isActive ? 'active' : ''}`;
                stepDiv.innerHTML = `
                    <div class="timeline-circle"></div>
                    <p>${step}</p>
                `;
                timelineElement.appendChild(stepDiv);
            });

            // 3. Render images (if any)
            const imagesContainerId = 'status-images';
            let imgContainer = document.getElementById(imagesContainerId);
            if (!imgContainer) {
                imgContainer = document.createElement('div');
                imgContainer.id = imagesContainerId;
                imgContainer.style.marginTop = '12px';
                imgContainer.style.display = 'flex';
                imgContainer.style.gap = '8px';
                const commLogEl = document.getElementById('communication-log');
                if (commLogEl && commLogEl.parentNode) {
                    commLogEl.parentNode.insertBefore(imgContainer, commLogEl.nextSibling);
                } else {
                    const modalContent = document.querySelector('#status-modal .modal-content');
                    if (modalContent) modalContent.appendChild(imgContainer);
                    else document.body.appendChild(imgContainer);
                }
            }
            if (imgContainer) imgContainer.innerHTML = '';
            if (grievance.images && grievance.images.length) {
                grievance.images.forEach((src, idx) => {
                    const thumb = document.createElement('div');
                    thumb.style.width = '96px';
                    thumb.style.height = '64px';
                    thumb.style.overflow = 'hidden';
                    thumb.style.border = '1px solid #ddd';
                    thumb.style.borderRadius = '6px';
                    thumb.style.cursor = 'pointer';
                    const img = document.createElement('img');
                    img.src = src;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    thumb.appendChild(img);
                    thumb.addEventListener('click', () => { window.open(src); });
                    imgContainer.appendChild(thumb);
                });
            }

            openModal('status-modal');
        };


        // --- New Feedback Features ---
        let currentFeedbackId = null;

        const openFeedbackModal = (id) => {
            currentFeedbackId = id;
            document.getElementById('feedback-id').textContent = id;
            document.getElementById('feedback-comment').value = '';
            setRating(0); // Reset stars
            openModal('feedback-modal');
        };

        const setRating = (value) => {
            const container = document.getElementById('rating-container');
            container.dataset.rating = value;
            const stars = container.querySelectorAll('span');
            stars.forEach(star => {
                const starValue = parseInt(star.dataset.value);
                star.classList.toggle('active', starValue <= value);
            });
        };

        const submitFeedback = async () => {
            const ratingContainer = document.getElementById('rating-container');
            const rating = parseInt(ratingContainer.dataset.rating);
            const comment = document.getElementById('feedback-comment').value;

            if (rating === 0) {
                alert("Please provide a star rating.");
                return;
            }

            try {
                const payload = `${rating}‚òÖ - ${comment}`;
                const res = await authFetch('https://hgsbackend-production.up.railway.app/api/grievances/' + currentFeedbackId + '/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error('Feedback failed');
                alert('Thank you for your feedback!');
                closeModal('feedback-modal');
                // optimistically update UI: attach feedback to local grievance and flash the row
                try{
                    const payload = `${rating}‚òÖ - ${comment}`;
                    const g = patientGrievances.find(x => (''+x.id) === (''+currentFeedbackId));
                    if (g) {
                        g.feedback = payload;
                        // re-render and highlight row
                        renderGrievanceList();
                        setTimeout(()=>{
                            const rows = document.getElementById('my-grievance-list').rows;
                            for(let r of rows){ if(r.cells[0] && (''+r.cells[0].textContent) === (''+currentFeedbackId)){ r.classList.add('flash'); setTimeout(()=>r.classList.remove('flash'),1200); break; } }
                        }, 100);
                    } else {
                        await fetchMyGrievances();
                    }
                }catch(e2){ console.warn('UI update failed', e2); await fetchMyGrievances(); }
            } catch (e) {
                console.error(e);
                alert('Failed to submit feedback to server.');
            }
        };

        // Initial load
        // Backend-powered: load grievances from server
        async function fetchMyGrievances() {
            try {
                const res = await authFetch('https://hgsbackend-production.up.railway.app/api/grievances/mine');
                if (!res.ok) throw new Error('Failed to fetch');
                const data = await res.json();
                // map server data to client shape and normalize status for display
                function mapStatus(raw){
    if (!raw) return 'Pending';

    const s = raw.toString().trim().toUpperCase();

    switch (s) {
        case 'PENDING':
            return 'Pending';

        case 'IN_REVIEW':
        case 'IN REVIEW':
            return 'In Review';

        case 'INVESTIGATING':
            return 'Investigating';

        case 'RESOLVED':
        case 'COMPLETED':
            return 'Resolved';

        case 'CLOSED':
            return 'Closed';

        default:
            return 'Pending';
    }
}



                patientGrievances = data.map(g => ({
                    id: g.id,
                    subject: g.title || '',
                    category: g.category || ((g.description && g.description.split('\n')[0]) || 'General'),
                    date: g.createdAt ? g.createdAt.split('T')[0] : '',
                    _rawStatus: g.status,
                    status: mapStatus(g.status),
                    anonymity: 'No',
                    log: [],
                    images: g.images || [],
                    feedback: g.feedback || null
                }));
                updateCounts();
                renderGrievanceList();
            } catch (e) {
                console.warn('Could not load grievances from server, using local data', e);
                updateCounts();
                renderGrievanceList();
            }
        }

        async function submitGrievanceToServer(payload) {
            try {
                const res = await authFetch('https://hgsbackend-production.up.railway.app/api/grievances', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    const text = await res.text().catch(()=>null);
                    const msg = `Server returned ${res.status} ${text || ''}`;
                    console.error('submitGrievanceToServer failed', res.status, text);
                    throw new Error(msg);
                }
                const data = await res.json();
                console.log('submitGrievanceToServer ok', data);
                return data;
            } catch (e) { console.error(e); throw e; }
        }

        function updateCounts() {
            document.getElementById('count-total').textContent = patientGrievances.length;
            document.getElementById('count-pending').textContent = patientGrievances.filter(g=>g.status==='Pending').length;
            document.getElementById('count-in-review').textContent = patientGrievances.filter(g=>g.status==='In Review').length;
            document.getElementById('count-resolved').textContent = patientGrievances.filter(g=>g.status==='Resolved').length;
            document.getElementById('count-closed').textContent = patientGrievances.filter(g=>g.status==='Closed').length;
        }

        // debounced search to reduce rendering churn
        function debounce(fn, wait){ let t; return function(...args){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); }; }
        const onSearch = debounce(() => { console.log('onSearch fired, value=', document.getElementById('search-input')?.value); renderGrievanceList(); }, 250);

        document.addEventListener('DOMContentLoaded', () => {
            // attach search and filter handlers after DOM ready to ensure elements exist
            const searchEl = document.getElementById('search-input');
            if (searchEl) {
                searchEl.addEventListener('input', onSearch);
                searchEl.addEventListener('keyup', onSearch);
                console.log('search listeners attached');
            } else console.warn('search-input not found at DOMContentLoaded');

            const statusFilterEl = document.getElementById('patient-status-filter');
            if (statusFilterEl) {
                statusFilterEl.addEventListener('change', renderGrievanceList);
            } else console.warn('patient-status-filter not found at DOMContentLoaded');

            fetchMyGrievances();
            // refresh periodically so status updates by staff/admin are reflected
            setInterval(fetchMyGrievances, 10000);
        });

        // populate navbar user info from localStorage
        // (function populateUser(){
        //     try{
        //         const raw = localStorage.getItem('user');
        //         if (!raw) return;
        //         const u = JSON.parse(raw);
        //         if (u && u.name) document.getElementById('nav-user-name').textContent = u.name;
        //         if (u && u.email) document.getElementById('nav-user-email').textContent = u.email;
        //     }catch(e){ /* ignore */ }
        // })();

        // render recent activity from patientGrievances logs
        function renderRecentActivity(){
            const container = document.getElementById('recent-activity');
            if (!container) {
                console.warn('renderRecentActivity: #recent-activity not found');
                return;
            }
            container.innerHTML = '';
            const items = [];
            patientGrievances.forEach(g => {
                if (g.log && g.log.length){
                    g.log.slice(-3).forEach(l => items.push({id:g.id, subj:g.subject, ts:l.timestamp, msg:l.message}));
                }
            });
            items.sort((a,b)=> (b.ts||'').localeCompare(a.ts||''));
            if (!items.length) { container.innerHTML = '<div class="muted">No recent activity</div>'; return; }
            items.slice(0,6).forEach(it=>{
                const el = document.createElement('div');
                el.style.padding = '8px 0';
                el.style.borderBottom = '1px solid #f0f0f0';
                el.innerHTML = `<div style="font-size:13px; font-weight:600;">${it.subj} <span style="font-weight:400; color:#777;">#${it.id}</span></div><div class="muted" style="font-size:13px;">${it.msg} <span style="float:right;">${it.ts}</span></div>`;
                container.appendChild(el);
            });
        }

        // update search summary when list renders (supports status filter)
        const origRender = renderGrievanceList;
        renderGrievanceList = function(){
            const statusFilter = document.getElementById('patient-status-filter')?.value;
            if (statusFilter) {
                const saved = patientGrievances;
                try {
                    patientGrievances = saved.filter(g => (g.status||'').toString() === statusFilter);
                    origRender();
                } finally { patientGrievances = saved; }
            } else {
                origRender();
            }

            const q = (document.getElementById('search-input')?.value || '').trim();
            const total = patientGrievances.length;
            const visible = document.getElementById('my-grievance-list') ? document.getElementById('my-grievance-list').rows.length : 0;
            const summary = q ? `Showing ${visible} of ${total} results for "${q}"` : `Showing ${visible} of ${total} grievances`;
            const ss = document.getElementById('search-summary'); if (ss) ss.textContent = summary;
            if (typeof renderRecentActivity === 'function') renderRecentActivity();
        }

        // Replace local submission handler with server-backed call
        document.getElementById('grievance-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const payload = {
                title: document.getElementById('grievance-subject').value,
                category: document.getElementById('grievance-category').value,
                description: document.getElementById('grievance-details').value,
                images: currentUploadData
            };

            try {
                const result = await submitGrievanceToServer(payload);
                alert('Grievance submitted (id: ' + result.id + ')');
                await fetchMyGrievances();
                this.reset();
                currentUploadData = [];
                updatePreviews();
            } catch (err) {
                console.error('Submit failed', err);
                alert('Failed to submit grievance: ' + (err && err.message ? err.message : 'Unknown error'));
            }
        });
    </script>
    <script>
        // populate nav user from localStorage if present
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const u = JSON.parse(localStorage.getItem('user') || 'null');
                if (u && u.name) document.getElementById('nav-user-name').textContent = u.name;
            } catch(e) { /* ignore */ }
        });
    </script>
</body>
</html>



